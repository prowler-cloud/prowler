---
name: gh-aw
description: >
  Create and maintain GitHub Agentic Workflows (gh-aw) for Prowler.
  Trigger: When creating agentic workflows, modifying gh-aw frontmatter, configuring safe-outputs,
  setting up MCP servers in workflows, importing Copilot Custom Agents, or debugging gh-aw compilation.
license: Apache-2.0
metadata:
  author: prowler-cloud
  version: "1.0"
  scope: [root]
  auto_invoke:
    - "Creating GitHub Agentic Workflows"
    - "Modifying gh-aw workflow frontmatter or safe-outputs"
    - "Configuring MCP servers in agentic workflows"
    - "Importing Copilot Custom Agents into workflows"
    - "Debugging gh-aw compilation errors"
allowed-tools: Read, Edit, Write, Glob, Grep, Bash, WebFetch
---

## When to Use

- Creating new `.github/workflows/*.md` agentic workflows
- Modifying frontmatter (triggers, permissions, safe-outputs, tools, MCP servers)
- Creating or importing `.github/agents/*.md` Copilot Custom Agents
- Debugging `gh aw compile` errors or warnings
- Configuring network access, rate limits, or footer templates

---

## File Layout

```
.github/
â”œâ”€â”€ workflows/
â”‚   â”œâ”€â”€ {name}.md              # Frontmatter + thin context dispatcher
â”‚   â””â”€â”€ {name}.lock.yml        # Auto-generated â€” NEVER edit manually
â”œâ”€â”€ agents/
â”‚   â””â”€â”€ {name}.md              # Full agent persona (reusable)
â””â”€â”€ aw/
    â””â”€â”€ actions-lock.json      # Action SHA pinning â€” commit this
```

See [references/](references/) for existing workflow and agent examples in this repo.

---

## Critical Patterns

### Two-File Architecture

Workflow file = **config + context only**. Agent file = **all reasoning logic**.

The workflow imports the agent via `imports:` and passes sanitized runtime context. The agent contains the persona, rules, steps, and output format. This separation makes agents reusable across workflows.

### Import Path Resolution

Paths resolve **relative to the importing file**, NOT from repo root:

```yaml
# From .github/workflows/my-workflow.md:
imports:
  - ../agents/my-agent.md        # CORRECT
  - .github/agents/my-agent.md   # WRONG â€” resolves to .github/workflows/.github/agents/
```

### Sanitized Context (Security)

NEVER pass raw `github.event.issue.body` to the agent:

```markdown
${{ needs.activation.outputs.text }}
```

### Read-Only Permissions + Safe Outputs

Workflows run read-only. Writes go through `safe-outputs`:

```yaml
# GOOD
permissions:
  issues: read
safe-outputs:
  add-comment:
    hide-older-comments: true

# BAD â€” never give the agent write access
permissions:
  issues: write
```

### Strict Mode

`strict: true` (default) enforces: no write permissions, explicit network config, no wildcard domains, ecosystem identifiers required. Set `strict: false` only during development.

### Footer Control

Prevent double footers with `messages.footer`:

```yaml
safe-outputs:
  messages:
    footer: "> ðŸ¤– Generated by [{workflow_name}]({run_url}) [Experimental]"
```

Variables: `{workflow_name}`, `{run_url}`, `{triggering_number}`, `{event_type}`, `{status}`.

### MCP Servers

Always use `allowed` to restrict tools. Add domains to `network.allowed`:

```yaml
network:
  allowed:
    - "mcp.prowler.com"

mcp-servers:
  prowler:
    url: "https://mcp.prowler.com/mcp"
    allowed:
      - prowler_hub_get_check_details
      - prowler_hub_get_check_code
      - prowler_docs_search
```

---

## Trigger Patterns

| Pattern | Trigger | Use Case |
|---------|---------|----------|
| LabelOps | `issues.types: [labeled]` + `names: [label]` | Triage, review |
| ChatOps | `issue_comment` + command parsing | Bot commands |
| DailyOps | `schedule: daily` | Reports, maintenance |
| IssueOps | `issues.types: [opened]` | Auto-triage on creation |

Dual-label gate (require trigger label + existing label):

```yaml
on:
  issues:
    types: [labeled]
    names: [ai-review]
if: contains(toJson(github.event.issue.labels), 'status/needs-triage')
```

---

## Safe Outputs Quick Reference

| Type | What | Key options |
|------|------|-------------|
| `add-comment` | Post comment | `hide-older-comments`, `target` |
| `create-issue` | Create issue | `title-prefix`, `labels`, `close-older-issues`, `expires` |
| `add-labels` | Add labels | `allowed` (restrict to list) |
| `remove-labels` | Remove labels | `allowed` (restrict to list) |
| `create-pull-request` | Create PR | `max`, `target-repo` |
| `close-issue` | Close issue | `target`, `required-labels` |
| `update-issue` | Update fields | `status`, `title`, `body` |
| `dispatch-workflow` | Trigger workflow | `workflows` (list) |

---

## AI Engines

| Engine | Value | Notes |
|--------|-------|-------|
| GitHub Copilot | `copilot` | Default, supports Custom Agents |
| Claude | `claude` | Anthropic |
| OpenAI Codex | `codex` | OpenAI |

---

## Commands

```bash
# Compile workflows (regenerates lock files)
gh aw compile

# Compile with strict validation
gh aw compile --strict

# Check workflow status
gh aw status

# Add a community workflow
gh aw add owner/repo/workflow.md

# Trigger manually
gh aw run workflow-name

# View logs
gh aw logs workflow-name
```

---

## Compilation Checklist

After modifying any `.github/workflows/*.md`:

- [ ] Run `gh aw compile` â€” check for errors
- [ ] Stage the `.lock.yml` alongside the `.md`
- [ ] Stage `.github/aw/actions-lock.json` if changed
- [ ] Verify `network.allowed` includes all MCP server domains
- [ ] Verify permissions are read-only (use safe-outputs for writes)

---

## .gitattributes

Add to repo root so lock files auto-resolve on merge:

```
.github/workflows/*.lock.yml linguist-generated=true merge=ours
```

---

## Resources

- **Examples**: See [references/](references/) for existing workflow and agent files in this repo
- **Documentation**: See [references/](references/) for links to gh-aw official docs
