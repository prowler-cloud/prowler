name: Label Community Contributors PRs

on:
  pull_request:
    types: [opened]

jobs:
  add-community-label:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Label community contributors
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Fetch fresh PR data to get current author_association
          ASSOCIATION=$(gh api /repos/${{ github.repository }}/pulls/${{ github.event.number }} --jq '.author_association')
          AUTHOR=$(gh api /repos/${{ github.repository }}/pulls/${{ github.event.number }} --jq '.user.login')

          echo "Author: $AUTHOR, Association: $ASSOCIATION"

          # Members have associations like: OWNER, MEMBER, COLLABORATOR
          # Non-members have: CONTRIBUTOR, FIRST_TIME_CONTRIBUTOR, FIRST_TIMER, NONE
          if [[ "$ASSOCIATION" != "OWNER" && "$ASSOCIATION" != "MEMBER" && "$ASSOCIATION" != "COLLABORATOR" ]]; then
            gh api /repos/${{ github.repository }}/issues/${{ github.event.number }}/labels \
              -X POST \
              -f labels[]='community'
            echo "Added 'community' label for $ASSOCIATION contributor"
          else
            echo "Skipped labeling for $ASSOCIATION"
          fi
