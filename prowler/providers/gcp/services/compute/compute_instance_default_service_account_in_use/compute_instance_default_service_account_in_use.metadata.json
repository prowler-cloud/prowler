{
  "Provider": "gcp",
  "CheckID": "compute_instance_default_service_account_in_use",
  "CheckTitle": "Compute Engine instance does not use the default service account",
  "CheckType": [],
  "ServiceName": "compute",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "medium",
  "ResourceType": "compute.googleapis.com/Instance",
  "Description": "**Compute Engine VMs** are evaluated for use of the **default service account** (`[PROJECT_NUMBER]-compute@developer.gserviceaccount.com`). The finding highlights instances configured with that account rather than a workload-specific service account. *GKE node VMs are ignored.*",
  "Risk": "Using the default service account often grants project-wide rights (e.g., `roles/editor`). If a VM is compromised, metadata tokens can be abused to read/modify resources, exfiltrate data, and pivot across services, impacting **confidentiality** and **integrity**, and potentially **availability**.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://cloud.google.com/iam/docs/granting-changing-revoking-access",
    "https://www.trendmicro.com/trendaivisiononecloudriskmanagement/knowledge-base/gcp/ComputeEngine/default-service-accounts-in-use.html"
  ],
  "Remediation": {
    "Code": {
      "CLI": "",
      "NativeIaC": "",
      "Other": "1. In Google Cloud console, go to Compute Engine > VM instances\n2. Click the VM, then click Stop and wait until it is stopped\n3. Click Edit\n4. Under Service account, select a non-default service account (not ending with \"-compute@developer.gserviceaccount.com\")\n5. Click Save, then click Start to power the VM back on\n6. If no suitable service account exists: IAM & Admin > Service Accounts > Create service account, grant only required roles, then repeat steps 2-5",
      "Terraform": "```hcl\n# Create a non-default service account\nresource \"google_service_account\" \"<example_resource_name>\" {\n  account_id = \"<example_resource_id>\"  # CRITICAL: custom SA to avoid default \"-compute@developer.gserviceaccount.com\"\n}\n\n# Attach the non-default service account to the VM\nresource \"google_compute_instance\" \"<example_resource_name>\" {\n  name         = \"<example_resource_name>\"\n  machine_type = \"e2-micro\"\n  zone         = \"<ZONE>\"\n\n  boot_disk { initialize_params { image = \"debian-cloud/debian-12\" } }\n  network_interface { network = \"default\" }\n\n  service_account {\n    email = google_service_account.<example_resource_name>.email  # CRITICAL: use non-default SA so the check passes\n  }\n}\n```"
    },
    "Recommendation": {
      "Text": "Avoid the default service account. Create per-workload service accounts and grant only required roles under **least privilege** and **separation of duties**. Remove broad roles like `roles/editor`. Prefer short-lived credentials and monitor service account usage to enforce **defense in depth**.",
      "Url": "https://hub.prowler.com/check/compute_instance_default_service_account_in_use"
    }
  },
  "Categories": [
    "identity-access"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
