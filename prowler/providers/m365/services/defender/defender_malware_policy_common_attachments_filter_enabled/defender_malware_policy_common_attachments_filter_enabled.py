from typing import List

from prowler.lib.check.models import Check, CheckReportM365
from prowler.providers.m365.services.defender.defender_client import defender_client


class defender_malware_policy_common_attachments_filter_enabled(Check):
    """
    Check if the Common Attachment Types Filter is enabled in the Defender anti-malware policy.

    Attributes:
        metadata: Metadata associated with the check (inherited from Check).
    """

    def execute(self) -> List[CheckReportM365]:
        """
        Execute the check to verify if the Common Attachment Types Filter is enabled.

        This method checks the Defender anti-malware policy to determine if the
        Common Attachment Types Filter is enabled.

        Returns:
            List[CheckReportM365]: A list of reports containing the result of the check.
        """
        findings = []

        if defender_client.malware_policies:
            # Only Default Defender Malware Policy exists
            default_policy = defender_client.malware_policies[0]
            if not defender_client.malware_rules:
                report = CheckReportM365(
                    metadata=self.metadata(),
                    resource=default_policy,
                    resource_name=default_policy.identity,
                    resource_id="defaultDefenderMalwarePolicy",
                )

                if default_policy.enable_file_filter:
                    # Case 1: Default policy exists and has the setting enabled
                    report.status = "PASS"
                    report.status_extended = "Common Attachment Types Filter is enabled in the default Defender Malware Policy (no other policies exist)."
                else:
                    # Case 5: Default policy exists but doesn't have the setting enabled
                    report.status = "FAIL"
                    report.status_extended = "Common Attachment Types Filter is not enabled in the default Defender Malware Policy (no other policies exist)."
                findings.append(report)

            # Multiple Defender Malware Policies exist
            else:
                disabled_filter_policies = []
                report = None
                for policy in defender_client.malware_policies:
                    if policy.is_default:
                        if not policy.enable_file_filter:
                            # Case 4: Default policy doesn't have the setting enabled (potential false positive if another policy overrides it)
                            report = CheckReportM365(
                                metadata=self.metadata(),
                                resource=policy,
                                resource_name=policy.identity,
                                resource_id="defaultDefenderMalwarePolicy",
                            )
                            report.status = "FAIL"
                            report.status_extended = "Common Attachment Types Filter is not enabled in the default Defender Malware Policy, but could be overridden by another policy which is out of Prowler's scope."
                            findings.append(report)
                            break
                    else:
                        if not policy.enable_file_filter:
                            disabled_filter_policies.append(policy.identity)

                if disabled_filter_policies:
                    # Case 3: Default policy has the setting enabled but some other policies don't
                    report = CheckReportM365(
                        metadata=self.metadata(),
                        resource={},
                        resource_name="Defender Malware Policies",
                        resource_id="defenderMalwarePolicies",
                    )
                    report.status = "FAIL"
                    report.status_extended = f"Common Attachment Types Filter is enabled in default Defender Malware Policy but not in the following Defender Malware Policies that may override it: {', '.join(disabled_filter_policies)}."
                    findings.append(report)
                elif not report:
                    # Case 2: Default policy has the setting enabled and all other policies do too
                    report = CheckReportM365(
                        metadata=self.metadata(),
                        resource={},
                        resource_name="Defender Malware Policies",
                        resource_id="defenderMalwarePolicies",
                    )
                    report.status = "PASS"
                    report.status_extended = "Common Attachment Types Filter is enabled in all Defender Malware Policies."
                    findings.append(report)

        return findings
