{
  "Provider": "oraclecloud",
  "CheckID": "compute_instance_legacy_metadata_endpoint_disabled",
  "CheckTitle": "Compute instance legacy metadata service endpoint is disabled",
  "CheckType": [],
  "ServiceName": "compute",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "Instance",
  "Description": "**OCI compute instance metadata service** is configured so legacy **IMDS v1** endpoints are disabled, requiring session-authorized **IMDS v2** requests for metadata access",
  "Risk": "Enabled **IMDS v1** permits unauthenticated metadata reads via local access or **SSRF**, compromising **confidentiality** of instance credentials, SSH keys, and custom data. Stolen tokens enable cloud API abuse, driving **privilege escalation**, **lateral movement**, and unauthorized changes that impact **integrity**.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/gettingmetadata.htm",
    "https://www.trendmicro.com/cloudoneconformity/knowledge-base/oci/OCI-Compute/enforce-imds-v2.html"
  ],
  "Remediation": {
    "Code": {
      "CLI": "oci compute instance update --instance-id <instance-ocid> --instance-options '{\"areLegacyImdsEndpointsDisabled\": true}'",
      "NativeIaC": "",
      "Other": "1. In the OCI Console, go to Compute > Instances\n2. Select <example_resource_name>\n3. In Instance Details, next to Instance metadata service, click Edit\n4. Set Allowed IMDS version to Version 2 only\n5. Click Save changes",
      "Terraform": "```hcl\nresource \"oci_core_instance\" \"<example_resource_name>\" {\n  instance_options {\n    are_legacy_imds_endpoints_disabled = true  # Critical: disables IMDSv1, allowing only IMDSv2\n  }\n}\n```"
    },
    "Recommendation": {
      "Text": "Disable **IMDS v1** and require **IMDS v2** across all instances. Migrate applications to session-authorized requests and confirm image support. Enforce **least privilege** for instance principals, restrict untrusted processes from reaching `169.254.169.254`, and monitor metadata access to provide **defense in depth**.",
      "Url": "https://hub.prowler.com/check/compute_instance_legacy_metadata_endpoint_disabled"
    }
  },
  "Categories": [
    "secrets",
    "identity-access"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
