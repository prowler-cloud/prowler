{
  "Provider": "azure",
  "CheckID": "aks_clusters_created_with_private_nodes",
  "CheckTitle": "AKS cluster nodes do not have public IP addresses",
  "CheckType": [],
  "ServiceName": "aks",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "microsoft.containerservice/managedclusters",
  "ResourceGroup": "container",
  "Description": "**AKS agent pools** use only private addressing, with node public IP assignment disabled (`enableNodePublicIP=false`). Clusters where any pool assigns a public IP to nodes are identified.",
  "Risk": "**Public node IPs** expose worker VMs to Internet scanning and exploit attempts against OS or kubelet services. Successful compromise can lead to stolen secrets and images (**confidentiality**), workload tampering (**integrity**), and node/resource exhaustion via DDoS or cryptomining (**availability**).",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://www.trendmicro.com/cloudoneconformity/knowledge-base/azure/AKS/private-cluster-nodes.html",
    "https://learn.microsoft.com/en-us/azure/aks/access-private-cluster",
    "https://learn.microsoft.com/en-us/azure/aks/private-clusters"
  ],
  "Remediation": {
    "Code": {
      "CLI": "",
      "NativeIaC": "```bicep\n// AKS cluster with nodes not assigned public IPs\nresource mc '<example_resource_name>@Microsoft.ContainerService/managedClusters@2024-05-01' = {\n  name: '<example_resource_name>'\n  location: '<location>'\n  identity: {\n    type: 'SystemAssigned'\n  }\n  properties: {\n    dnsPrefix: '<example_resource_name>'\n    agentPoolProfiles: [\n      {\n        name: 'nodepool1'\n        count: 1\n        vmSize: 'Standard_DS2_v2'\n        enableNodePublicIP: false // CRITICAL: ensures nodes have no public IPs\n      }\n    ]\n  }\n}\n```",
      "Other": "1. In the Azure portal, go to Kubernetes services > <your AKS cluster> > Node pools\n2. For any node pool showing Node public IP: Enabled, click Add node pool\n3. Create the new pool with the same size/count; set Node public IP to Disabled (or uncheck Enable node public IP)\n4. Wait until the new pool is Ready\n5. If replacing a system pool, set the new pool to Mode: System (or Set as default system pool)\n6. Delete the old node pool(s) that had Node public IP enabled\n7. Verify all node pools show Node public IP: Disabled",
      "Terraform": "```hcl\n# AKS cluster with node public IPs disabled\nresource \"azurerm_kubernetes_cluster\" \"<example_resource_name>\" {\n  name                = \"<example_resource_name>\"\n  location            = \"<location>\"\n  resource_group_name = \"<example_resource_name>\"\n  dns_prefix          = \"<example_resource_name>\"\n\n  default_node_pool {\n    name                  = \"default\"\n    node_count            = 1\n    vm_size               = \"Standard_DS2_v2\"\n    enable_node_public_ip = false # CRITICAL: ensures nodes have no public IPs\n  }\n\n  identity {\n    type = \"SystemAssigned\"\n  }\n}\n```"
    },
    "Recommendation": {
      "Text": "Disable **public node IPs** on all agent pools (`enableNodePublicIP=false`) and route egress via a **NAT gateway** or **Azure Firewall**. Apply **least privilege** with NSGs blocking Internet ingress, use **private endpoints** and **bastion/VPN** for admin access, and adopt **defense in depth** with continuous hardening and monitoring.",
      "Url": "https://hub.prowler.com/check/aks_clusters_created_with_private_nodes"
    }
  },
  "Categories": [
    "internet-exposed",
    "trust-boundaries",
    "cluster-security"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
