{
  "Provider": "azure",
  "CheckID": "storage_ensure_soft_delete_is_enabled",
  "CheckTitle": "Storage account has soft delete for containers enabled",
  "CheckType": [],
  "ServiceName": "storage",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "medium",
  "ResourceType": "microsoft.storage/storageaccounts",
  "ResourceGroup": "storage",
  "Description": "**Azure Storage accounts** have **container soft delete** enabled via a retention policy that keeps deleted containers for a set period.",
  "Risk": "Without this, container deletions are permanent, reducing **availability** and **integrity**. A compromised user or faulty automation could erase entire datasets, forcing slow restores from backups and extending RTO/RPO, with potential downstream app outages.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://www.trendmicro.com/cloudoneconformity-staging/knowledge-base/azure/StorageAccounts/enable-soft-delete.html#",
    "https://learn.microsoft.com/en-us/azure/storage/blobs/soft-delete-blob-overview",
    "https://learn.microsoft.com/en-us/azure/storage/blobs/soft-delete-blob-enable?tabs=azure-portal"
  ],
  "Remediation": {
    "Code": {
      "CLI": "az storage account blob-service-properties update --resource-group <example_resource_name> --account-name <example_resource_name> --enable-container-delete-retention true --container-delete-retention-days 7",
      "NativeIaC": "```bicep\n// Enable container soft delete on the storage account\nresource blobService 'Microsoft.Storage/storageAccounts/blobServices@2023-04-01' = {\n  name: '<example_resource_name>/default'\n  properties: {\n    containerDeleteRetentionPolicy: {\n      enabled: true // Critical: enables soft delete for containers\n      days: 7       // Required when enabled\n    }\n  }\n}\n```",
      "Other": "1. In the Azure portal, go to Storage accounts and open <storage account>\n2. Under Data management, select Data protection\n3. In the Containers section, turn on Soft delete for containers and set Retention (days) to a value (e.g., 7)\n4. Click Save",
      "Terraform": "```hcl\n# Enable container soft delete on the storage account\nresource \"azurerm_storage_account\" \"<example_resource_name>\" {\n  name                     = \"<example_resource_name>\"\n  resource_group_name      = \"<example_resource_name>\"\n  location                 = \"<example_resource_name>\"\n  account_tier             = \"Standard\"\n  account_replication_type = \"LRS\"\n\n  blob_properties {\n    container_delete_retention_policy {\n      enabled = true  # Critical: enables soft delete for containers\n      days    = 7     # Required when enabled\n    }\n  }\n}\n```"
    },
    "Recommendation": {
      "Text": "Enable **container soft delete** and choose a retention window (`7-365` days) that meets your RPO. Pair with **blob soft delete** and **versioning** for layered recovery. Enforce **least privilege** on delete actions and apply resource **locks** to prevent destructive changes.",
      "Url": "https://hub.prowler.com/check/storage_ensure_soft_delete_is_enabled"
    }
  },
  "Categories": [
    "resilience"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "Additional storage costs may be incurred as snapshots are retained."
}
