{
  "Provider": "azure",
  "CheckID": "keyvault_recoverable",
  "CheckTitle": "Key Vault has soft delete and purge protection enabled",
  "CheckType": [],
  "ServiceName": "keyvault",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "microsoft.keyvault/vaults",
  "ResourceGroup": "security",
  "Description": "**Azure Key Vault** recoverability requires both `enable_soft_delete` and `enable_purge_protection`. With these enabled, vault objects remain recoverable after deletion and cannot be permanently purged during the retention period.",
  "Risk": "Absent these protections, deleted vaults or objects can be permanently removed, cutting access to keys, secrets, and certificates. This can render data unreadable, break app authentication, and halt signing/verification, degrading **availability** and **integrity**. Malicious insiders can purge to block recovery.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://learn.microsoft.com/en-us/azure/key-vault/general/key-vault-recovery?tabs=azure-cli",
    "https://www.trendmicro.com/trendaivisiononecloudriskmanagement/knowledge-base/azure/KeyVault/enable-key-vault-recoverability.html#"
  ],
  "Remediation": {
    "Code": {
      "CLI": "az keyvault update -g <resourceGroupName> -n <keyVaultName> --enable-soft-delete true --enable-purge-protection true",
      "NativeIaC": "```bicep\n// Enable soft delete and purge protection on an existing/new Key Vault\nresource kv 'Microsoft.KeyVault/vaults@2023-07-01' = {\n  name: '<example_resource_name>'\n  location: '<location>'\n  properties: {\n    tenantId: '<tenant_id>'\n    sku: { name: 'standard' }\n    enableSoftDelete: true        // Critical: ensures soft delete is enabled\n    enablePurgeProtection: true   // Critical: prevents permanent purge during retention\n  }\n}\n```",
      "Other": "1. In Azure Portal, go to Key vaults and open <keyVaultName>\n2. Select Properties > Recovery\n3. Turn on Soft delete and Purge protection\n4. Click Save",
      "Terraform": "```hcl\nresource \"azurerm_key_vault\" \"<example_resource_name>\" {\n  name                = \"<example_resource_name>\"\n  location            = \"<location>\"\n  resource_group_name = \"<resource_group_name>\"\n  tenant_id           = \"<tenant_id>\"\n  sku_name            = \"standard\"\n\n  soft_delete_enabled      = true  # Critical: enables soft delete\n  purge_protection_enabled = true  # Critical: enables purge protection\n}\n```"
    },
    "Recommendation": {
      "Text": "Enable both `enable_soft_delete` and `enable_purge_protection` on all vaults. Enforce with policy, restrict purge/recover to **least privilege** and apply **separation of duties**. Keep backups and test recovery. Monitor delete/purge with alerts. *Adjust retention to business needs* to strengthen defense in depth.",
      "Url": "https://hub.prowler.com/check/keyvault_recoverable"
    }
  },
  "Categories": [
    "resilience"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "Once purge-protection and soft-delete are enabled for a Key Vault, the action is irreversible."
}
