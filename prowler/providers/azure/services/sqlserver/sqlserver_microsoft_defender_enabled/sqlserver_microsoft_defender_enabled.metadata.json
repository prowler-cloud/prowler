{
  "Provider": "azure",
  "CheckID": "sqlserver_microsoft_defender_enabled",
  "CheckTitle": "SQL Server has Microsoft Defender for SQL enabled",
  "CheckType": [],
  "ServiceName": "sqlserver",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "microsoft.sql/servers",
  "ResourceGroup": "database",
  "Description": "**Azure SQL Server** instances are evaluated for the server-level **security alert policy** of **Microsoft Defender for SQL**, expecting the policy state to be `Enabled`.",
  "Risk": "Without **Defender for SQL**, anomalous logins, SQL injection patterns, and risky configurations may go undetected, enabling data exfiltration (**confidentiality**), unauthorized changes (**integrity**), and disruptive queries or ransomware (**availability**).",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://www.azadvertizer.net/azpolicyadvertizer/7fe3b40f-802b-4cdd-8bd4-fd799c948cc2.html",
    "https://learn.microsoft.com/en-us/azure/azure-sql/database/azure-defender-for-sql?view=azuresql",
    "https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-sql-usage",
    "https://www.trendmicro.com/cloudoneconformity-staging/knowledge-base/azure/SecurityCenter/defender-azure-sql.html",
    "https://learn.microsoft.com/en-us/azure/defender-for-cloud/policy-reference"
  ],
  "Remediation": {
    "Code": {
      "CLI": "az rest --method PUT --url \"https://management.azure.com/subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Sql/servers/<SERVER_NAME>/securityAlertPolicies/Default?api-version=2023-08-01-preview\" --body '{\"properties\":{\"state\":\"Enabled\"}}'",
      "NativeIaC": "```bicep\nparam serverName string = '<example_resource_name>'\n\nresource securityAlert 'Microsoft.Sql/servers/securityAlertPolicies@2021-11-01' = {\n  name: '${serverName}/Default'\n  properties: {\n    state: 'Enabled' // Critical: enables the server's security alert policy (Defender for SQL)\n  }\n}\n```",
      "Other": "1. Sign in to the Azure portal > SQL servers > select <SERVER_NAME>\n2. Under Security, select Microsoft Defender for SQL (or Microsoft Defender for Cloud)\n3. Toggle to On (Enable) and click Save",
      "Terraform": "```hcl\nresource \"azurerm_mssql_server_security_alert_policy\" \"<example_resource_name>\" {\n  server_id = \"<example_resource_id>\"\n  state     = \"Enabled\" # Critical: enables the server's security alert policy (Defender for SQL)\n}\n```"
    },
    "Recommendation": {
      "Text": "Enable **Microsoft Defender for SQL** across all servers and managed instances, preferably at subscription scope. Apply **least privilege**, restrict public exposure, and integrate alerts with your SOC. Regularly review **vulnerability assessment** results and harden findings as part of **defense in depth**.",
      "Url": "https://hub.prowler.com/check/sqlserver_microsoft_defender_enabled"
    }
  },
  "Categories": [
    "logging",
    "forensics-ready"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "Microsoft Defender for SQL is a paid feature and will incur additional cost for each SQL server."
}
