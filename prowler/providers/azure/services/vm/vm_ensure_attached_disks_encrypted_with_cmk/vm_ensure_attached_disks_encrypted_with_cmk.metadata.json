{
  "Provider": "azure",
  "CheckID": "vm_ensure_attached_disks_encrypted_with_cmk",
  "CheckTitle": "Virtual machine OS or data disk is encrypted with a customer-managed key (CMK)",
  "CheckType": [],
  "ServiceName": "vm",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "medium",
  "ResourceType": "microsoft.compute/disks",
  "Description": "Attached Azure managed disks (OS and data) are assessed to confirm encryption uses **customer-managed keys** (`CMK`) via disk encryption sets rather than platform-managed keys. Scope includes disks currently attached to VMs, evaluating their encryption type to verify CMK is applied.",
  "Risk": "Without **CMK**, you lose control over key lifecycle and access. This weakens confidentiality and compliance: you can't enforce independent rotation, promptly revoke keys to crypto-lock stolen copies/snapshots, or separate duties. Misuse or compromise may keep data readable beyond your trust boundary.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://eloysalamanca.es/security/disks/encryption/disk-encryption-key-rotation-and-file-level-restore-on-azure-vms/",
    "https://blog.terenceluk.com/2021/05/azure-server-side-encryption-sse-and.html",
    "https://learn.microsoft.com/en-us/azure/virtual-machines/disk-encryption-overview",
    "https://docs.prowler.com/checks/azure/azure-general-policies/bc_azr_general_1#terraform",
    "https://docs.accops.com/develop/content/core_features/Azure_VM_Disk_Encryption.html",
    "https://support.icompaas.com/support/solutions/articles/62000229895-ensure-that-os-and-data-disks-are-encrypted-with-customer-managed-key-cmk-",
    "https://learn.microsoft.com/en-US/Azure/virtual-machines/disk-encryption-overview",
    "https://mihirpopat.medium.com/mastering-azure-disk-storage-scenario-based-questions-for-real-world-challenges-19728ccfc3ee",
    "https://www.trendmicro.com/cloudoneconformity/knowledge-base/azure/VirtualMachines/sse-boot-disk-cmk.html#",
    "https://learn.microsoft.com/en-us/azure/security/fundamentals/data-encryption-best-practices#protect-data-at-rest"
  ],
  "Remediation": {
    "Code": {
      "CLI": "",
      "NativeIaC": "```bicep\n// Encrypt a managed disk with a customer-managed key via Disk Encryption Set (DES)\nresource disk 'Microsoft.Compute/disks@2023-10-02' = {\n  name: '<example_resource_name>'\n  location: '<LOCATION>'\n  sku: {\n    name: 'Standard_LRS'\n  }\n  properties: {\n    creationData: {\n      createOption: 'Empty'\n    }\n    diskSizeGB: 32\n\n    // CRITICAL: Use CMK by attaching a Disk Encryption Set (DES)\n    // This switches encryption from platform-managed to customer-managed\n    encryption: {\n      type: 'EncryptionAtRestWithCustomerKey' // critical: CMK\n      diskEncryptionSetId: '<example_resource_id>' // critical: DES resource ID\n    }\n  }\n}\n```",
      "Other": "1. In Azure Portal, open the target VM and click Stop to deallocate it.\n2. For each data disk: Go to VM > Disks > select the data disk > Detach > Save.\n3. In the portal search box, open Disks, select the detached disk > Encryption.\n4. Set Encryption type to Customer-managed key (Disk encryption set), select your Disk Encryption Set, then Save.\n5. Reattach the disk: VM > Disks > Add data disk (select the same disk) > Save.\n6. For OS disk, use Swap OS disk: create a new managed disk from a snapshot/image with Encryption type = Customer-managed key (select the same DES), then VM > Disks > Swap OS disk and choose that disk.\n7. Start the VM.",
      "Terraform": "```hcl\n# Encrypt a managed disk with a customer-managed key via Disk Encryption Set (DES)\nresource \"azurerm_managed_disk\" \"<example_resource_name>\" {\n  name                = \"<example_resource_name>\"\n  location            = \"<LOCATION>\"\n  resource_group_name = \"<example_resource_name>\"\n  storage_account_type = \"Standard_LRS\"\n  create_option        = \"Empty\"\n  disk_size_gb         = 32\n\n  # CRITICAL: Attach DES to enable SSE with CMK and pass the check\n  disk_encryption_set_id = \"<example_resource_id>\" # critical: DES ID\n}\n```"
    },
    "Recommendation": {
      "Text": "Use **CMK** with disk encryption sets for all attached OS and data disks.\n- Enforce **least privilege** on key usage and scope\n- Enable periodic key rotation and auditing\n- Store keys in HSM-backed vaults; separate key and data admins\n- Combine with **encryption at host** to cover temp disks and caches",
      "Url": "https://hub.prowler.com/check/vm_ensure_attached_disks_encrypted_with_cmk"
    }
  },
  "Categories": [
    "encryption"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "Using CMK/BYOK will entail additional management of keys."
}
