{
  "Provider": "azure",
  "CheckID": "vm_trusted_launch_enabled",
  "CheckTitle": "Virtual Machine has Trusted Launch with Secure Boot and vTPM enabled",
  "CheckType": [],
  "ServiceName": "vm",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "medium",
  "ResourceType": "microsoft.compute/virtualmachines",
  "ResourceGroup": "compute",
  "Description": "**Azure VMs** are evaluated for **Trusted Launch** with both **Secure Boot** and **vTPM** enabled.\n\nIdentifies VMs not set to `TrustedLaunch` or missing `secureBootEnabled` and `vTpmEnabled` together.",
  "Risk": "Missing **Trusted Launch** weakens boot-chain integrity. Attackers can persist via bootkits/rootkits, bypass OS controls, steal secrets, and tamper with drivers. Loss of attestation reduces detection, risking **integrity**, **confidentiality**, and **availability** through stealthy, hard-to-remediate compromises.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://learn.microsoft.com/en-us/azure/virtual-machines/trusted-launch"
  ],
  "Remediation": {
    "Code": {
      "CLI": "az vm update --resource-group <RESOURCE_GROUP> --name <VM_NAME> --security-type TrustedLaunch --enable-secure-boot true --enable-vtpm true",
      "NativeIaC": "```bicep\n// Enables Trusted Launch with Secure Boot and vTPM on the VM\nresource vm 'Microsoft.Compute/virtualMachines@2022-11-01' = {\n  name: '<example_resource_name>'\n  location: '<region>'\n  properties: {\n    securityProfile: {\n      securityType: 'TrustedLaunch' // Critical: sets VM security type to Trusted Launch\n      uefiSettings: {\n        secureBootEnabled: true     // Critical: enables Secure Boot\n        vTpmEnabled: true           // Critical: enables vTPM\n      }\n    }\n  }\n}\n```",
      "Other": "1. In Azure Portal, open the VM and click Stop to deallocate it\n2. Go to Settings > Configuration\n3. Under Security type, select Trusted launch\n4. Check Secure Boot and vTPM\n5. Click Save\n6. Start the VM from the Overview page",
      "Terraform": "```hcl\n# Patch the existing VM to enable Trusted Launch with Secure Boot and vTPM\nresource \"azapi_update_resource\" \"<example_resource_name>\" {\n  type        = \"Microsoft.Compute/virtualMachines@2022-11-01\"\n  resource_id = \"<example_resource_id>\"\n\n  body = jsonencode({\n    properties = {\n      securityProfile = {\n        securityType = \"TrustedLaunch\" # Critical: sets VM security type to Trusted Launch\n        uefiSettings = {\n          secureBootEnabled = true      # Critical: enables Secure Boot\n          vTpmEnabled       = true      # Critical: enables vTPM\n        }\n      }\n    }\n  })\n}\n```"
    },
    "Recommendation": {
      "Text": "Adopt **defense in depth**: enable **Trusted Launch** with **Secure Boot** and **vTPM** on Gen2 VMs. Standardize on images with signed boot components and use supported sizes/OS. Enforce **least privilege** for administrators and enable attestation monitoring to prevent and detect boot-level tampering.",
      "Url": "https://hub.prowler.com/check/vm_trusted_launch_enabled"
    }
  },
  "Categories": [
    "node-security"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "Secure Boot and vTPM are not currently supported for Azure Generation 1 VMs. IMPORTANT: Before enabling Secure Boot and vTPM on a Generation 2 VM which does not already have both enabled, it is highly recommended to create a restore point of the VM prior to remediation."
}
