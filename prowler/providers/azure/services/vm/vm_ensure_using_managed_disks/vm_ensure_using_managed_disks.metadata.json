{
  "Provider": "azure",
  "CheckID": "vm_ensure_using_managed_disks",
  "CheckTitle": "Virtual Machine uses managed disks for OS and data disks",
  "CheckType": [],
  "ServiceName": "vm",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "microsoft.compute/virtualmachines",
  "ResourceGroup": "compute",
  "Description": "**Azure virtual machines** use **managed disks** for the OS disk and every data disk, rather than page blob VHDs in storage accounts.\n\nThe evaluation confirms that all attached VM disks are managed.",
  "Risk": "Using **unmanaged disks** ties VM data to storage account keys and SAS, increasing exposure of disk contents if those secrets leak (**confidentiality/integrity**). Limited platform resiliency and quotas increase **availability** risk. With Azure retiring unmanaged disks on `2026-03-31`, such VMs may be stopped and unable to start.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://learn.microsoft.com/en-us/azure/virtual-machines/unmanaged-disks-deprecation",
    "https://learn.microsoft.com/en-us/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks",
    "https://www.trendmicro.com/trendaivisiononecloudriskmanagement/knowledge-base/azure/VirtualMachines/managed-disks-in-use.html",
    "https://learn.microsoft.com/en-us/security/benchmark/azure/security-controls-v3-data-protection#dp-4-enable-data-at-rest-encryption-by-default"
  ],
  "Remediation": {
    "Code": {
      "CLI": "az vm convert --resource-group <RESOURCE_GROUP> --name <VM_NAME>",
      "NativeIaC": "```bicep\n// VM configured to use a managed OS disk\nresource vm 'Microsoft.Compute/virtualMachines@2023-09-01' = {\n  name: '<example_resource_name>'\n  location: resourceGroup().location\n  properties: {\n    hardwareProfile: { vmSize: 'Standard_DS1_v2' }\n    storageProfile: {\n      osDisk: {\n        name: 'osdisk'\n        osType: 'Linux'\n        createOption: 'Attach'\n        managedDisk: {\n          id: '<example_resource_id>' // CRITICAL: attaching a managed disk makes the VM use managed disks\n        }\n      }\n    }\n    networkProfile: { networkInterfaces: [ { id: '<example_resource_id>' } ] }\n  }\n}\n```",
      "Other": "1. In Azure Portal, go to Virtual machines > select your VM\n2. Click Stop to deallocate the VM\n3. In the VM menu, select Disks\n4. Click Migrate to managed disks, then click Migrate to start\n5. After migration completes, click Start to power on the VM\n6. If the VM is in an availability set: first go to Availability sets > select the set > Convert to managed (SKU: Aligned), then repeat steps 1-5",
      "Terraform": "```hcl\n# VM attached to a managed OS disk\nresource \"azurerm_virtual_machine\" \"<example_resource_name>\" {\n  name                  = \"<example_resource_name>\"\n  location              = \"<LOCATION>\"\n  resource_group_name   = \"<RESOURCE_GROUP>\"\n  network_interface_ids = [\"<example_resource_id>\"]\n  vm_size               = \"Standard_DS1_v2\"\n\n  storage_os_disk {\n    name            = \"osdisk\"\n    create_option   = \"Attach\"\n    managed_disk_id = \"<example_resource_id>\" # CRITICAL: use a managed disk for the OS disk\n  }\n}\n```"
    },
    "Recommendation": {
      "Text": "Adopt **managed disks** for all VM OS and data volumes.\n- Enforce **least privilege** via RBAC at disk scope\n- Use encryption at rest; prefer `CMEK` when mandated\n- Apply backups/snapshots and zone-aware designs for **defense in depth**\n- After migration, delete orphaned VHD blobs to avoid data exposure and cost.",
      "Url": "https://hub.prowler.com/check/vm_ensure_using_managed_disks"
    }
  },
  "Categories": [
    "resilience"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": "There are additional costs for managed disks based off of disk space allocated. When converting to managed disks, VMs will be powered off and back on."
}
