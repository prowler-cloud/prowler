{
  "Provider": "aws",
  "CheckID": "iam_inline_policy_allows_privilege_escalation",
  "CheckTitle": "IAM inline policy does not allow privilege escalation",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices",
    "Software and Configuration Checks/Industry and Regulatory Standards/AWS Foundational Security Best Practices",
    "TTPs/Privilege Escalation"
  ],
  "ServiceName": "iam",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "AwsIamPolicy",
  "ResourceGroup": "IAM",
  "Description": "**IAM inline policies** are evaluated for permission combinations that enable **privilege escalation**, such as `sts:AssumeRole`, `iam:PassRole`, attaching/editing policies, or broad wildcards. The result highlights inline policies that allow a principal to obtain higher effective access.",
  "Risk": "Excessive inline policy permissions let identities escalate to admin, compromising CIA:\n- Confidentiality: read secrets and data\n- Integrity: alter policies, code, and configs\n- Availability: delete or stop resources, disable logging\nAttackers can persist by creating keys/users or assuming powerful roles.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege",
    "https://bishopfox.com/blog/privilege-escalation-in-aws",
    "https://github.com/RhinoSecurityLabs/Security-Research/blob/master/tools/aws-pentest-tools/aws_escalate.py",
    "https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/",
    "https://labs.reversec.com/posts/2025/08/another-ecs-privilege-escalation-path"
  ],
  "Remediation": {
    "Code": {
      "CLI": "",
      "NativeIaC": "```yaml\n# CloudFormation: Replace the risky inline policy with least-privilege actions\nResources:\n  <example_resource_name>:\n    Type: AWS::IAM::UserPolicy\n    Properties:\n      UserName: <example_resource_name>\n      PolicyName: <example_resource_name>\n      PolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Action: ec2:DescribeInstances  # FIX: allow only non-privilege-escalation action; remove IAM/STS privilege-escalation actions\n            Resource: \"*\"                  # FIX: no risky wildcard admin actions; this read-only action is safe\n```",
      "Other": "1. In the AWS Console, go to IAM > Users/Roles/Groups and select the entity with the failing inline policy\n2. In the Permissions tab, under Inline policies, choose the flagged policy and click Edit\n3. Remove privilege-escalation actions (e.g., iam:CreatePolicyVersion, iam:AttachUserPolicy, iam:PassRole, sts:AssumeRole, iam:UpdateAssumeRolePolicy)\n4. Keep only the minimum required, non-escalating permissions (for example, read-only actions)\n5. Save changes",
      "Terraform": "```hcl\n# Terraform: Replace the risky inline policy with least-privilege actions\nresource \"aws_iam_user_policy\" \"<example_resource_name>\" {\n  name = \"<example_resource_name>\"\n  user = \"<example_resource_name>\"\n\n  policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [{\n      Effect   = \"Allow\"\n      Action   = \"ec2:DescribeInstances\"  # FIX: only non-privilege-escalation action; remove IAM/STS escalation actions\n      Resource = \"*\"                       # FIX: safe read-only scope\n    }]\n  })\n}\n```"
    },
    "Recommendation": {
      "Text": "Apply **least privilege** and remove escalation paths:\n- Avoid wildcards and sensitive actions like `sts:AssumeRole`, `iam:PassRole`, or policy modification without tight scope\n- Restrict by resource and `Condition`\n- Prefer managed, versioned policies; use permissions boundaries/SCPs\n- Require reviews and MFA for admins",
      "Url": "https://hub.prowler.com/check/iam_inline_policy_allows_privilege_escalation"
    }
  },
  "Categories": [
    "identity-access",
    "privilege-escalation"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
