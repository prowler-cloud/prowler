{
  "Provider": "aws",
  "CheckID": "iam_role_cross_service_confused_deputy_prevention",
  "CheckTitle": "IAM service role prevents cross-service confused deputy attack",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices",
    "TTPs/Privilege Escalation"
  ],
  "ServiceName": "iam",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "AwsIamRole",
  "ResourceGroup": "IAM",
  "Description": "**IAM service role** trust policies restrict **AWS service principals** to expected sources using global condition keys like `aws:SourceArn` or `aws:SourceAccount`, avoiding overly broad `sts:AssumeRole` trust relationships.",
  "Risk": "Unrestricted service-principal trust lets outsiders trigger a **cross-service confused deputy**, causing unintended `sts:AssumeRole`.\nThis can enable data exfiltration, unauthorized changes, and lateral movement, impacting **confidentiality** and **integrity**.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html",
    "https://aws.amazon.com/blogs/security/how-to-set-up-least-privilege-access-to-your-encrypted-amazon-sqs-queue/",
    "https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html#cross-service-confused-deputy-prevention",
    "https://docs.aws.amazon.com/textract/latest/dg/cross-service-confused-deputy-prevention.html"
  ],
  "Remediation": {
    "Code": {
      "CLI": "aws iam update-assume-role-policy --role-name <example_resource_name> --policy-document '{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\",\"Principal\":{\"Service\":\"<service>.amazonaws.com\"},\"Action\":\"sts:AssumeRole\",\"Condition\":{\"StringEquals\":{\"aws:SourceAccount\":\"<ACCOUNT_ID>\"}}}]}'",
      "NativeIaC": "```yaml\n# CloudFormation: IAM role trust policy with confused deputy protection\nResources:\n  <example_resource_name>:\n    Type: AWS::IAM::Role\n    Properties:\n      AssumeRolePolicyDocument:\n        Version: '2012-10-17'\n        Statement:\n          - Effect: Allow\n            Principal:\n              Service: <service>.amazonaws.com\n            Action: sts:AssumeRole\n            Condition:\n              StringEquals:\n                aws:SourceAccount: <ACCOUNT_ID>  # CRITICAL: restricts the service to calls from this account to prevent cross-service confused deputy\n```",
      "Other": "1. In the AWS console, go to IAM > Roles\n2. Open <example_resource_name> and select the Trust relationships tab\n3. Click Edit trust policy\n4. In the statement for Principal Service \"<service>.amazonaws.com\", add a Condition block:\n   - StringEquals: aws:SourceAccount = <ACCOUNT_ID>\n5. Save changes\n6. Re-run the check to confirm the role now prevents cross-service confused deputy attacks",
      "Terraform": "```hcl\n# IAM role trust policy with confused deputy protection\nresource \"aws_iam_role\" \"<example_resource_name>\" {\n  name = \"<example_resource_name>\"\n\n  # CRITICAL: Condition restricts service to this account to prevent cross-service confused deputy\n  assume_role_policy = jsonencode({\n    Version = \"2012-10-17\"\n    Statement = [\n      {\n        Effect    = \"Allow\"\n        Principal = { Service = \"<service>.amazonaws.com\" }\n        Action    = \"sts:AssumeRole\"\n        Condition = {\n          StringEquals = { \"aws:SourceAccount\" = \"<ACCOUNT_ID>\" }\n        }\n      }\n    ]\n  })\n}\n```"
    },
    "Recommendation": {
      "Text": "Constrain service-role trust to expected callers using `aws:SourceArn`/`aws:SourceAccount` to bind service principals to specific resources or accounts. If unsupported, apply equivalent limits in resource-based policies or org-level controls. Apply **least privilege** and review trust relationships regularly.",
      "Url": "https://hub.prowler.com/check/iam_role_cross_service_confused_deputy_prevention"
    }
  },
  "Categories": [
    "identity-access",
    "trust-boundaries"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
