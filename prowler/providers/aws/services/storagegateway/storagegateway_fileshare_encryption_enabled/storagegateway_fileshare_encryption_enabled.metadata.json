{
  "Provider": "aws",
  "CheckID": "storagegateway_fileshare_encryption_enabled",
  "CheckTitle": "Storage Gateway file share is encrypted with KMS CMK",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices",
    "Software and Configuration Checks/Industry and Regulatory Standards/AWS Foundational Security Best Practices",
    "Software and Configuration Checks/Industry and Regulatory Standards/NIST 800-53 Controls (USA)",
    "Software and Configuration Checks/Industry and Regulatory Standards/PCI-DSS",
    "Software and Configuration Checks/Industry and Regulatory Standards/ISO 27001 Controls",
    "Software and Configuration Checks/Industry and Regulatory Standards/SOC 2",
    "Software and Configuration Checks/Industry and Regulatory Standards/HIPAA Controls (USA)",
    "Effects/Data Exposure"
  ],
  "ServiceName": "storagegateway",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "medium",
  "ResourceType": "Other",
  "ResourceGroup": "storage",
  "Description": "Storage Gateway file shares configured with **customer-managed KMS keys (CMKs)** for server-side encryption of objects written to S3.\n\nFile shares without an explicit KMS key (e.g., `SSE-KMS` or `DSSE-KMS`) are identified.",
  "Risk": "Without **CMEK**, encryption relies on provider-managed keys, reducing control over who can decrypt and when. This weakens confidentiality by limiting key-policy enforcement, revocation, and auditable key use, increasing exposure from stolen S3 credentials or overly permissive roles.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://www.trendmicro.com/trendaivisiononecloudriskmanagement-staging/knowledge-base/aws/StorageGateway/file-shares-encrypted-with-cmk.html#",
    "https://docs.aws.amazon.com/filegateway/latest/files3/encrypt-objects-stored-by-file-gateway-in-amazon-s3.html"
  ],
  "Remediation": {
    "Code": {
      "CLI": "aws storagegateway update-nfs-file-share --file-share-arn <example_resource_arn> --kms-encrypted --kms-key <example_kms_key_arn>",
      "NativeIaC": "```yaml\n# CloudFormation: enable KMS CMK encryption for a Storage Gateway NFS file share\nResources:\n  <example_resource_name>:\n    Type: AWS::StorageGateway::NFSFileShare\n    Properties:\n      ClientToken: \"<example_resource_id>\"\n      GatewayARN: \"<example_resource_arn>\"\n      LocationARN: \"<example_resource_arn>\"\n      Role: \"<example_resource_arn>\"\n      KMSEncrypted: true  # Critical: enables KMS CMK encryption for the file share\n      KMSKey: \"<example_kms_key_arn>\"  # Critical: CMK ARN used for encryption\n```",
      "Other": "1. In the AWS Console, go to Storage Gateway > File shares\n2. Select the affected file share and click Edit\n3. Under Encryption, choose AWS KMS key\n4. Select the CMK to use (or paste its ARN)\n5. Save changes",
      "Terraform": "```hcl\n# Enable KMS CMK encryption for a Storage Gateway NFS file share\nresource \"aws_storagegateway_nfs_file_share\" \"<example_resource_name>\" {\n  client_list  = [\"<example_cidr_block>\"]\n  gateway_arn  = \"<example_resource_arn>\"\n  location_arn = \"<example_resource_arn>\"\n  role_arn     = \"<example_resource_arn>\"\n\n  kms_encrypted = true              # Critical: enables KMS CMK encryption\n  kms_key_arn   = \"<example_kms_key_arn>\"  # Critical: CMK ARN used for encryption\n}\n```"
    },
    "Recommendation": {
      "Text": "Use a **customer-managed KMS key** for each file share's server-side encryption (`SSE-KMS`; *consider* `DSSE-KMS` for multilayer needs). Apply **least privilege** and **separation of duties** to key access, rotate keys, monitor key usage, and restrict scope to necessary principals and regions.",
      "Url": "https://hub.prowler.com/check/storagegateway_fileshare_encryption_enabled"
    }
  },
  "Categories": [
    "encryption"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
