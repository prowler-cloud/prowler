{
  "Provider": "aws",
  "CheckID": "vpc_endpoint_services_allowed_principals_trust_boundaries",
  "CheckTitle": "VPC endpoint service allows only trusted principals or none",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices/Network Reachability",
    "Software and Configuration Checks/Industry and Regulatory Standards/AWS Foundational Security Best Practices",
    "TTPs/Initial Access",
    "Effects/Data Exposure"
  ],
  "ServiceName": "vpc",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "AwsEc2VpcEndpointService",
  "ResourceGroup": "network",
  "Description": "**VPC endpoint services** are assessed for their **allowed principals**, comparing each to a configured set of trusted accounts and identifying any **untrusted principals** or a wildcard `*` present in the allowlist.",
  "Risk": "Untrusted or wildcard principals can create PrivateLink connections to your service, eroding segmentation. This enables unauthorized data access (**confidentiality**), abuse of internal APIs (**integrity**), and excess load on backends (**availability**).",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.aws.amazon.com/vpc/latest/privatelink/vpc-endpoints-access.html"
  ],
  "Remediation": {
    "Code": {
      "CLI": "",
      "NativeIaC": "```yaml\n# Allow only a trusted principal (or attach none to allow no principals)\nResources:\n  <example_resource_name>:\n    Type: AWS::EC2::VPCEndpointServicePermissions\n    Properties:\n      ServiceId: <example_resource_id>\n      AllowedPrincipals:\n        - arn:aws:iam::<TRUSTED_ACCOUNT_ID>:root  # CRITICAL: restricts access to only this trusted account\n```",
      "Other": "1. Open the AWS VPC console and go to Endpoint services\n2. Select the endpoint service (<example_resource_id>)\n3. Open the Allowed principals tab and click Edit allowed principals\n4. Remove all entries that are not trusted, including any wildcard (*)\n5. Optionally leave the list empty (no principals) or keep only trusted account IDs/ARNs\n6. Save changes",
      "Terraform": "```hcl\n# Allow only a trusted principal (delete this resource to allow none)\nresource \"aws_vpc_endpoint_service_allowed_principal\" \"<example_resource_name>\" {\n  service_id    = \"<example_resource_id>\"\n  principal_arn = \"arn:aws:iam::<TRUSTED_ACCOUNT_ID>:root\"  # CRITICAL: only this trusted account can create endpoints\n}\n```"
    },
    "Recommendation": {
      "Text": "Apply **least privilege**: restrict **allowed principals** to vetted account IDs and avoid `*`. Maintain a central trust registry, enforce **separation of duties** with approval workflows, and review entries regularly. Use **defense in depth** with strong service authentication and continuous configuration monitoring.",
      "Url": "https://hub.prowler.com/check/vpc_endpoint_services_allowed_principals_trust_boundaries"
    }
  },
  "Categories": [
    "trust-boundaries"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
