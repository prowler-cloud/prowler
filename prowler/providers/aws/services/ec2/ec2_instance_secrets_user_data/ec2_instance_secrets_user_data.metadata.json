{
  "Provider": "aws",
  "CheckID": "ec2_instance_secrets_user_data",
  "CheckTitle": "EC2 instance user data contains no secrets",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices",
    "Sensitive Data Identifications/Security",
    "Sensitive Data Identifications/Passwords",
    "Effects/Data Exposure"
  ],
  "ServiceName": "ec2",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "AwsEc2Instance",
  "ResourceGroup": "compute",
  "Description": "**EC2 instance User Data** is inspected for **secret-like values** (credentials, tokens, keys). Both plain and compressed content are parsed, honoring configured exclusions, to identify patterns that resemble sensitive material within initialization scripts.",
  "Risk": "**Secrets embedded in User Data** undermine confidentiality and integrity. Anyone with instance or build-system access can read them, reuse credentials to call services, exfiltrate data, or move laterally. Exposure may persist in AMIs, snapshots, and backups, increasing blast radius over time.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.aws.amazon.com/secretsmanager/latest/userguide/tutorials_basic.html",
    "https://support.icompaas.com/support/solutions/articles/62000127092-ensure-no-secrets-are-found-in-ec2-user-data"
  ],
  "Remediation": {
    "Code": {
      "CLI": "aws ec2 modify-instance-attribute --instance-id <INSTANCE_ID> --user-data \"Value=\"",
      "NativeIaC": "```yaml\n# CloudFormation: EC2 instance with empty user data\nResources:\n  <example_resource_name>:\n    Type: AWS::EC2::Instance\n    Properties:\n      ImageId: <AMI_ID>\n      InstanceType: t3.micro\n      UserData: !Base64 \"\"  # Critical: empty user data ensures no secrets are present\n```",
      "Other": "1. Open the AWS EC2 console and go to Instances\n2. Select the affected instance\n3. Click Actions > Instance settings > Edit user data\n4. Delete all contents of the user data field\n5. Click Save",
      "Terraform": "```hcl\nresource \"aws_instance\" \"<example_resource_name>\" {\n  ami           = \"<AMI_ID>\"\n  instance_type = \"t3.micro\"\n  user_data     = \"\" # Critical: empty user data so no secrets are stored\n}\n```"
    },
    "Recommendation": {
      "Text": "Avoid placing secrets in User Data. Store them in a **managed secret service** and fetch at runtime via a **least-privilege instance role**. Prefer short-lived credentials with **regular rotation**. Limit who can view or edit User Data and apply **defense in depth** with automated secret scanning in build pipelines.",
      "Url": "https://hub.prowler.com/check/ec2_instance_secrets_user_data"
    }
  },
  "Categories": [
    "secrets"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
