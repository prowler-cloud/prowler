{
  "Provider": "aws",
  "CheckID": "ec2_instance_internet_facing_with_instance_profile",
  "CheckTitle": "EC2 instance is not internet-facing with an instance profile attached",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices/Network Reachability",
    "TTPs/Initial Access",
    "TTPs/Credential Access"
  ],
  "ServiceName": "ec2",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "AwsEc2Instance",
  "ResourceGroup": "compute",
  "Description": "**EC2 instances** with a public IP address and an attached **instance profile** (IAM role) are identified.\n\nInstances lacking public exposure or without an instance profile are excluded.",
  "Risk": "Publicly reachable instances with **IAM role credentials** expand the blast radius. Remote exploits or misconfigurations can steal credentials via the **instance metadata service**, enabling unauthorized API calls, data exfiltration, and lateral movement, impacting confidentiality, integrity, and availability.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_switch-role-ec2_instance-profiles.html",
    "https://aws.amazon.com/blogs/aws/aws-web-application-firewall-waf-for-application-load-balancers/",
    "https://support.icompaas.com/support/solutions/articles/62000127121-ensure-instance-profile-is-attached-for-internet-facing-ec2-instances"
  ],
  "Remediation": {
    "Code": {
      "CLI": "aws ec2 disassociate-iam-instance-profile --association-id <ASSOCIATION_ID>",
      "NativeIaC": "```yaml\n# CloudFormation: EC2 instance without a public IP to avoid being internet-facing\nResources:\n  <example_resource_name>:\n    Type: AWS::EC2::Instance\n    Properties:\n      ImageId: <example_ami_id>\n      InstanceType: t3.micro\n      NetworkInterfaces:\n        - DeviceIndex: 0\n          SubnetId: <example_resource_id>\n          AssociatePublicIpAddress: false  # Critical: disables public IPv4 so the instance is not internet-facing\n```",
      "Other": "1. In the AWS Console, go to EC2 > Instances and select the instance\n2. Choose Actions > Security > Modify IAM role\n3. Set IAM role to None and click Update IAM role\n4. Verify the instance no longer lists an IAM role (instance profile)\n\nAlternative (if you need the role): remove internet exposure\n1. Select the instance > Networking tab\n2. If an Elastic IP is attached, choose Disassociate Elastic IP\n3. For auto-assigned public IPv4, stop the instance and relaunch without a public IP or in a subnet without auto-assign public IPv4",
      "Terraform": "```hcl\n# EC2 instance without a public IP to avoid being internet-facing\nresource \"aws_instance\" \"<example_resource_name>\" {\n  ami           = \"<example_ami_id>\"\n  instance_type = \"t3.micro\"\n  associate_public_ip_address = false  # Critical: disables public IPv4 so the instance is not internet-facing\n}\n```"
    },
    "Recommendation": {
      "Text": "Avoid direct Internet exposure. Place workloads behind an **Application Load Balancer** and protect HTTP apps with **WAF**. Remove public IPs or restrict ingress to trusted sources. Apply **least privilege** to instance profiles and enforce **IMDSv2**. Use **bastion hosts** or **Session Manager** for admin access.",
      "Url": "https://hub.prowler.com/check/ec2_instance_internet_facing_with_instance_profile"
    }
  },
  "Categories": [
    "internet-exposed",
    "identity-access"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
