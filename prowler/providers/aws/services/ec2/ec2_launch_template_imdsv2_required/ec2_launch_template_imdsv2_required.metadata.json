{
  "Provider": "aws",
  "CheckID": "ec2_launch_template_imdsv2_required",
  "CheckTitle": "EC2 launch template has IMDSv2 enabled and required or instance metadata service disabled",
  "CheckType": [
    "Software and Configuration Checks/AWS Security Best Practices",
    "Software and Configuration Checks/Industry and Regulatory Standards/AWS Foundational Security Best Practices",
    "Software and Configuration Checks/Industry and Regulatory Standards/CIS AWS Foundations Benchmark",
    "TTPs/Credential Access",
    "Effects/Data Exposure"
  ],
  "ServiceName": "ec2",
  "SubServiceName": "",
  "ResourceIdTemplate": "",
  "Severity": "high",
  "ResourceType": "AwsEc2LaunchTemplate",
  "ResourceGroup": "compute",
  "Description": "EC2 launch templates are inspected for **Instance Metadata Service** configuration. It identifies versions where `http_endpoint` is `enabled` and `http_tokens` is `required` (IMDSv2 enforced), versions with the metadata service `disabled`, and versions that allow metadata without requiring tokens.",
  "Risk": "Allowing metadata access without **IMDSv2** enables SSRF and open proxy paths to query instance metadata, exposing temporary credentials and secrets. Attackers can steal IAM role credentials to access data, modify resources, and pivot within the account, threatening confidentiality and integrity.",
  "RelatedUrl": "",
  "AdditionalURLs": [
    "https://docs.aws.amazon.com/autoscaling/ec2/userguide/create-launch-template.html#change-metadata-options",
    "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html",
    "https://docs.aws.amazon.com/securityhub/latest/userguide/ec2-controls.html#ec2-170"
  ],
  "Remediation": {
    "Code": {
      "CLI": "aws ec2 create-launch-template-version --launch-template-id <example_resource_id> --source-version <example_source_version> --launch-template-data '{\"MetadataOptions\":{\"HttpTokens\":\"required\"}}'",
      "NativeIaC": "```yaml\nResources:\n  <example_resource_name>:\n    Type: AWS::EC2::LaunchTemplate\n    Properties:\n      LaunchTemplateName: <example_resource_name>\n      LaunchTemplateData:\n        MetadataOptions:\n          HttpTokens: required  # CRITICAL: Require IMDSv2 (blocks IMDSv1) to pass the check\n```",
      "Other": "1. In the AWS Console, go to EC2 > Launch Templates\n2. Select the launch template, then choose Actions > Modify template (Create new version)\n3. Expand Advanced details > Metadata options\n4. Set Http tokens to Required (or disable Metadata accessible)\n5. Click Create template version\n6. (Optional) Set this new version as Default if you want it used for future launches",
      "Terraform": "```hcl\nresource \"aws_launch_template\" \"<example_resource_name>\" {\n  name = \"<example_resource_name>\"\n\n  metadata_options {\n    http_tokens = \"required\" # CRITICAL: Require IMDSv2 (blocks IMDSv1) to pass the check\n  }\n}\n```"
    },
    "Recommendation": {
      "Text": "Enforce **IMDSv2** in all launch template versions by setting token use to `required`; disable the metadata service when not needed. Apply **least privilege** to instance roles and use **defense in depth** (egress filtering, input validation) to reduce SSRF paths. Ensure applications and SDKs are compatible with IMDSv2.",
      "Url": "https://hub.prowler.com/check/ec2_launch_template_imdsv2_required"
    }
  },
  "Categories": [
    "secrets"
  ],
  "DependsOn": [],
  "RelatedTo": [],
  "Notes": ""
}
